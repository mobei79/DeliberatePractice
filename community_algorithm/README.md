# 向勇代码实现
    DeliberatePractice\community_algorith/community_detect_by_xiangyong
    
    逻辑：抽取逾期用户触黑用户构建网络，挖掘社区，按照通过率逾期率比例进行判别；    
    数据处理流：
        需要两张维度表：
            表1.1：网贷借款用户借款明细表  dwi.dwi_user_feature_lend_detail_day    存用户借款信息，主要用于筛选出逾期的用户
            表1.2： 特殊触黑用户表 dwi_usr_special_list_full 标注用户是否公检法名单，是否黑名单，是否逾期名单，是否多头借贷；主要用于筛选触黑用户；
                两表中触黑用户和逾期用户一起构成社区发现目标用户群；
            表2：网贷用户特征关系表    dwi_user_feature_lend_detail_day    存用户关系，这就需要从用户注册表，用户通讯录表，用户通话记录表等表中综合抽取；
        1. 在表1.1取已到期且逾期用户 + 表1.2中逾期触黑用户；然后关联表2中该用户的各种关系，并且根据关系type设置权重阈值；得到用户关联关系网络（person1, person2）
        2. 读取数据到本地：‘/data.csv’ “hive -e "%(hql)s" > %(filePath)s”
        3. 创建hive表：dm_loan_usr_cluster_d，存储用户和用户所在社区
        4. 读取本地文件，调用networkx.read_edgelist()生成图graph;
            调用 python-louvain.community.best_partition(graph) 进行社区发现得到最佳划分结果bast_partition；
            进行格式转换后，存储到本地csv文件
            将csv文件上传到hive中 “load data local inpath '%(filePath)s' overwrite into table %(dbName)s.%(tbName)s partition(%(partition)s)”
        5. 经过以上处理，我们得到了 (loan_id，community_id)
            然后需要关联其他表，得到统计信息(通过率和逾期率)，都是一些hivesql 【可以当做练习】；
                dm_loan_usr_cluster_d表关联dwi_user_feature_lend_detail_day ；得到一个社区中用户通过的数目以及百分比；到期的数目；逾期的数目以及百分比；
                然后筛选出通过率>=0.7 && 逾期率>=0.7的用户；
    详细模型流程：
        
# CommunityDetection-master.zip   
    \DeliberatePractice\community_algorithm\CommunityDetection-master\algorithm
    
    是网上一个人的代码实现，包含了若干种常用的社区发现算法。如Louvain、LOA、SCAN、LFM、CPM等

# 我的实验代码，以及对比 改进
    software\NeoGraphX0723  实验的工程代码 scala 包含图分析，图计算，LPA，louvain算法实现
    D:\software\mavenwokestation\Louvainmodel   online工程代码包 louvain算法 scala实现
    
    逻辑：调用spark-neo4j接口通过cypher从neo4j中抽取用户关系数据【我抽取的是特定时间内全部数据】；然后使用GraphX生成图；使用louvain代码进行社区挖掘；
    后续流程：数据处理完是写到hdfs中，我需要进行合并，过滤（节点少的社区），合并（重复度高的社区进行合并），抽取社区指标，通过机器学习分类模型；将结果写入neo4j；对外提供接口；
    
    问题：
        1. 通过上面流程，可见相较于向勇的模型，我们的想法过于复杂，这还没考虑louvain算法挖掘的问题【如社区过大，脏数据，模型参数设置等】；
        2. 模型一定是离线的，T+n更新的，采用这些思路需要考虑louvain模型参数；社区划分结果处理；社区分类模型参数；过于臃肿，这也导致了我们的效果不好；
        

    综合改进：
        向勇模型【挖掘欺诈团伙】，可以准确的挖掘逾期触黑用户中是否有社区，目的性更强，也较简单；缺点是无法预测未逾期用户；但是未逾期用户通常可能和这些社区存在联系，模型也没问题；
        全量社区挖掘【进行预测和分析】，只要用户社区找的准确，就可以将紧密的社区能为业务和推荐提供依据；比如挖掘社区用户行为属性，社区中心化程度，社区中心用户等，增加推荐准确性；

        优化：
            1. 使用向勇的模型，挖掘欺诈社区+业务人工筛选出的社区，作为负样本；
            2. 抽取还款稳定信用良好的社区作为正样本；
            3. 丰富我们用户分类的指标，，社区用户行为属性，各种占比，时间窗内行为次数；社区中用户重要新程度；社区中心用户等
            4. 经过1,2,3三部，我们可以得到一个更好的分类模型，在全量社区中进行判断，
                * 提前预警危险可疑社区；【风控】
                * 提前命中高质量社区；【推荐】
                * 挖掘社区中心用户，社区间核心关联用户；【推荐】
            5.  剔除噪声数据（无效的地址电话等）；考虑特征组合；社区划分过大部分用户污染整个社区；设置louvain阈值
        
# 对比总结
    模型1适合挖掘欺诈团伙；
    模型2适合挖掘网络中的社区结构进行推荐
    构建网络：
        用户选择：
            1 选取触黑用户+逾期用户 【模型1】
            2 选取全部用户【模型2】
        关系选择： 
            1 选择全部关系，设备、邀请、紧急联系人、同事、亲属、通讯录、通话记录、注册电话、公司、地址等【模型2 ：1.给每种关系赋予权重；2. 设置关系阈值小于1的不要；】
            2 根据网络指标和抽样，对关系类型，关系阈值进行限定；【模型1:只抽取了设备电话等关系加权了】
    社区挖掘：
        算法选择：
            1 python中有networkx+python-louvain包;
            2 neo4j 中也内置了 louvain
            3 spark自己实现louvain；或者sparkMlib中的LPA包
            4 LPA算法 infomap算法
        环境选择：
            1 spark 可以并行，不管是pyspark还是scala都能有效的提升计算效率；
            2 Python中也有很多成熟的算法包，可以直接调用，在服务器上跑就行；主要看数据量，和算法复杂度；
    社区分类：
        机器学习分类：
            1 需要很多的正负样本；社区划分之后需要抽取量化社区指标；然后训练模型，多少是增加了很多不确定性；还得根据结果的质量评判；
        指标分类：
            1 选择通过率低但是逾期率高的社区为欺诈团伙；拒绝率>0.7且逾期率>0.7；简单直接，准确性高；但是多说只能针对高度可疑的社区，实用性低；
    
    后续使用：
        1 社区评分结果/或者社区危险程度等级输入neo4j；或者单独建一个用户-社区表存储结果； 共其他接口调用，挖掘新入网用户的1,2度关系，给出评分；
        2 挖掘全量用户社区，优化社区分类模型质量，是它可以分类（高/中/低质量社区）
                * 提前预警危险可疑社区；【风控】
                * 提前命中高质量社区；【推荐】
        3 挖掘社区中心用户，社区间核心关联用户；【推荐】
        4 T+1挖掘社区结构，统计社区指标，计算社区评分，将社区编号信息，评分信息等同步到Neo4j中；供实时查询
    
        5 模型使用效果：模型2：能够发现部分问题用户确实存在社区关系；能够发现业务人员排查出的诈骗团伙剩下的人，可以配合使用；一周内危险社区存在着新用户加入的情况且都为通过；
    
# 数据量和模型准确度
    准确率accuracy：95%；（由于基于逾期用户构建的网络，所以）   召回率recall：80%+
    
    基础图数据：
        561万用户；7种类型节点共1.15亿节点；12种关系共2.46亿关联关系；
    构建用户网络
        基于九种关系（设备，ip*0.3，地址*0.9，注册电话，紧急联系人，通讯录，通话详单*0.9，邀请信息，其他组合关系）抽取用户关系，构建用户;
        抽取出115万用户，1226万条关系；（先进性社交网络分析 - 网络密度）
        平均度数20.7；聚类系数2.25；网络密度0.7；还是比较符合真是网络结构的；【通过网络指标来判断构建网络的可用性】
    社区发现：
        louvain: 得到社区31万个；有效社区6 1557个；危险团伙1202个
        LPA：     得到社区27万个；有效社区9 1061个；危险社区2180个
        我们计算了louvain的全局模块度Q = 0.221;【标准网络的模块度0.3-0.7】
    社区分类：
        0 最开始并没有使用机器学习分类，而是采用指标分类：
            危险社区： 630个（2/5以上人触黑 或者2/5以上进件发生逾期）
            可疑社区： 30346个（有人触黑或者有进件逾期） 
            其他社区： 64047个（暂未分析是否存在潜在的危险社区） 
            后来结合数据分析，找到了关联ip个数、关联手机个数、关联设备个数、社区成员进件次数、通过次数、逾期次数、社区内进件时间跨度、二度网络设计用户数目等的
        1.1 分类采用的样本数据： 
            业务员抽取出367个诈骗团伙，4000人；抽取表现良好关系紧密社区379个，4000人【按条件抽取不具备普遍性 身份证未触黑、社区进件数目大于5、通过数目大于4、未发生逾期、且7/8为最近12个月内产生的进件】
        1.2 社区挖掘结果处理
            过滤掉社区数目小于3的小社区；并且将社区重合比例超过2/3的社区进行合并；
        1.3 社区指标抽取
                通过率，逾期率，触黑率，电话触黑率，12月内进件占比等指标
                是否有成员触黑；
                是否存在逾期情况；
                社区成员注册电话是否触黑；
                紧急联系人是否触黑；
                社区中和触黑电话存在关系人占比大于20%；
                和触黑电话存在关系的进件数目大于15%；
                12个月内产生过进件的触黑人员数目大于1；
                12个月内触黑人员产生的进件大于1；
                通过率小于0.25；
                平均申请地址个数大于1；
                平均申请地址个数大于等于1且平均给公司地址个数大于1；
                是否公司电话触黑；
                通讯录中触黑电话数目大于1；
           近三个月贷款次数大于3； 
            另一种简单的划分方式：
                危险社区：用户触黑率大于33%或者逾期率大于70%
                可疑社区：触黑率大于5%或者逾期率大于5%
        



# 社区发现用户关系数据抽取
    1. 构建用户关联关系表：（type,user1,user2,weight）
        使用了用户注册数据，用户邀请数据，用户通讯录数据，用户通话详单数据等，抽取出用户关联关系，

    向勇社区发现模型逻辑为：主要是通过【设备、ip、联系人、通讯录、通话记录、邀请和分享、经纬度、地址】等数据构建网贷用户关系网络，然后训练社区发现模型，识别出欺诈团伙；
        1. 选择通过率低但是逾期率高的社区为欺诈团伙；拒绝率>0.7且逾期率>0.7
        2. 构建用户关联网络分成了两部：抽取用户关联关系 + 构建用户关联网络
            2.1 抽取用户关联关系
                用到了如下几个维度【设备、ip、联系人、通讯录、通话记录、邀请和分享、经纬度、地址】分别是
                   1表示同设备，2表示同IP，3表示同联系人、4表示联系人是注册用户手机号、5表示联系人在注册用户通讯录中、6表示联系人在注册用户通话记录中，7表示同通讯录，8表示同通话记录 
                抽取用户关联关系之后，存储至hive分表，方便使用
            2.2 构建用户关联网络
                抽取账单到期+逾期超1天的用户 unionall 黑名单中用户；
                让这些用户关联dwi_user_feature_relation_day表，抽取如下五钟关系的用户
                    (s.type=3)
                    or (s.type=4 and s.from_id<>s.to_id)
                    or (s.type=7 and weight>=5)
                    or (s.type=8 and weight>=3)
                    or (s.type=1 and weight>=1) 
                **注意这里是对关系进行筛选：同设备登录；至少一个联系人手机号码相同；至少一个联系人是其他注册用户；通讯录中有三个以上相同手机号码；被叫电话中相同5个以上；
        3. 社区挖掘直接使用了networkx + python-louvain包
    
    模型对比：
        向勇模型：
            只取逾期用户和触黑用户，这样只用分析逾期用户的用户关联网络，挖掘社区结构；
            属于抽取逾期用户的社会关系，然后挖掘逾期用户中是否有社区结构，通过判断通过率和逾期率来判定是否是诈骗团伙】
        我的模型：   
            直接从neo4j中，通过cypher语句抽取用户关联关系，使用graphX接口生成图，然后进行社区发现。可以并行计算；
            我选取了全用户的网络挖掘社区结构，然后根据社区指标以及衍生变量指标，进行社区分类；
        想法：
            好坏社区只能根据业务提供的200多危险用户团体，样本量太少；正样本是随机选取的，不具有普遍性；
            所以向勇模型，只取逾期用户，如果逾期用户中存在社区，就很有可能是团伙；这是一种很好的预测方式；准确度比我的高，也简单；
            我的模型可以进行优化，使用类似于向勇的模型来挖掘出可疑的社区结构，用于分类；
    用自己的模型其中共有两部分处理的很繁琐：
        1. 过滤掉社区数目小于3的小社区；并且将社区重合比例超过2/3的社区进行合并；
        2. 随机抽取通过率高逾期率低的社区作为正样本，将业务筛选出的诈骗团伙和挖掘到的社区进行对比，重合率高于2/3的社区就作为负样本；训练机器学习分类模型；进行分类；
        这种完全是查看危险社区的特征，如通过率，逾期率，触黑率，电话触黑率，12月内进件占比等指标；然后调整分类模型，最终也没有的出很好的效果；
    业务员抽取出367个诈骗团伙，4000人；抽取表现良好关系紧密社区379个，4000人
    
    
    后续功能：
        社区发现后一部分是可以直接提供给反诈部门进行分析；另一部分是通过用户进件属性将其与已知社区关联，通过关联社区的属性对其进行观察和判定。
        将挖掘得到的社区作为属性存储到neo4j中，包含所在社区，社区编号，是否危险社区三个参数；新用户属性更新之后，自动调用接口进行查询，将指标信息返回给风控模型

    优化点：
        剔除噪声数据（无效的地址电话等）；考虑特征组合；社区划分过大部分用户污染整个社区；
        


        


    
part1
    
    经过统计分析，存在明显差异的特征有如下几项：
    触黑人数	"逾期数目
    预期占比"		注册电话触黑	紧急联系人电话触黑	
    电话触黑人数	电话触黑进件数	12月内触黑进件人数	
    12个月内触黑人员进件个数	12个月内逾期进件个数	
    6月内触黑进件人数	6个月内触黑人员进件个数	6个月内逾期进件个数
    
    其中只有逾期数目始于进件贷后表现，其余的风控触黑标签。其中“电话触黑个数”无法作为统计指标，因为安全社区也存在电话触黑的情况，可能是通讯录关联到的，但是这无法作为依据
    由此可知，风控触黑标签可以作为社区是否危险的强关系；逾期数目作为一种潜在的区分指标；
    12月内进件数目占比，进件人数占比都比较高，也就是说最近12月内所有社区进件量都比较几种，在危险社区中，触黑人数大多数为12月内进件，
    
    
    存在差异，但是不太明显的有如下
    "未通过数目	"通过数目
    申请地址个数	公司地址个数	公司电话触黑	
    公司电话个数	通讯录电话触黑	3天连续进件个数
    
    除了通讯录电话触黑，公司电话触黑外，其他的可以作为特征值处理；3天连续进件个数 不具备特殊性了